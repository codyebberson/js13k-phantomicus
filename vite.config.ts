import { js13kViteConfig } from 'js13k-vite-plugins';
import { BuildOptions, Terser, TerserOptions, UserConfigExport } from 'vite';
import { defineConfig } from 'vitest/config';

const config: UserConfigExport = {
  test: {
    globals: true,
  },
  // ...js13kViteConfig({ roadrollerOptions: false }),
  // ...js13kViteConfig(),
  ...js13kViteConfig({
    roadrollerOptions: {
      allowFreeVars: true,
      numAbbreviations: 15,
      recipLearningRate: 1910,
      modelMaxCount: 3,
      modelRecipBaseCount: 94,
      precision: 16,
      sparseSelectors: [0, 1, 2, 3, 5, 6, 13, 25, 42, 101, 449, 458],
    },
  }),
};

const buildOptions = config.build as BuildOptions;
const terserOptions = buildOptions.terserOptions as TerserOptions;
const mangleOptions = terserOptions.mangle as Terser.MangleOptions;
const propertiesOptions = mangleOptions.properties as Terser.ManglePropertiesOptions;

// Allow Terser mangling of built-in functions and property names
// This is dangerous, and almost certain to break your code
// So we have to carefully add necessary built-ins to our own "reserved" list
propertiesOptions.builtins = true;
propertiesOptions.reserved = [
  'catch',
  'then',
  'toFixed',
  'toString',
  'min',
  'max',
  'Math',
  'AudioContext',
  'for',
  'random',
  'sin',
  'PI',
  'cos',
  'of',
  'exp',
  'tanh',
  'Float32Array',
  'hypot',
  'document',
  'querySelectorAll',
  'canvas',
  'window',
  'innerWidth',
  'innerHeight',
  'px',
  'addEventListener',
  'resize',
  'at',
  'mt',
  'pt',
  'atan2',
  'version',
  'float',
  'in',
  'texture',
  'normalize',
  'sqrt',
  'pow',
  'layout',
  'location',
  'inverse',
  'is',
  'as',
  'Uint32Array',
  'Array',
  'null',
  'ms',
  'tan',
  'acos',
  'bold',
  'blur',
  'vi',
  'abs',
  'sign',
  'continue',
  'arguments',
  'navigator',
  'getGamepads',
  'top',
  'LOADING',
  'on',
  'requestAnimationFrame',
  'left',
  'constructor',

  // String
  'length',
  'constructor',
  'anchor',
  'at',
  'big',
  'blink',
  'bold',
  'charAt',
  'charCodeAt',
  'codePointAt',
  'concat',
  'endsWith',
  'fontcolor',
  'fontsize',
  'fixed',
  'includes',
  'indexOf',
  'isWellFormed',
  'italics',
  'lastIndexOf',
  'link',
  'localeCompare',
  'match',
  'matchAll',
  'normalize',
  'padEnd',
  'padStart',
  'repeat',
  'replace',
  'replaceAll',
  'search',
  'slice',
  'small',
  'split',
  'strike',
  'sub',
  'substr',
  'substring',
  'sup',
  'startsWith',
  'toString',
  'toWellFormed',
  'trim',
  'trimStart',
  'trimLeft',
  'trimEnd',
  'trimRight',
  'toLocaleLowerCase',
  'toLocaleUpperCase',
  'toLowerCase',
  'toUpperCase',
  'valueOf',

  // Array
  'length',
  'constructor',
  'at',
  'concat',
  'copyWithin',
  'fill',
  'find',
  'findIndex',
  'findLast',
  'findLastIndex',
  'lastIndexOf',
  'pop',
  'push',
  'reverse',
  'shift',
  'unshift',
  'slice',
  'sort',
  'splice',
  'includes',
  'indexOf',
  'join',
  'keys',
  'entries',
  'values',
  'forEach',
  'filter',
  'flat',
  'flatMap',
  'map',
  'every',
  'some',
  'reduce',
  'reduceRight',
  'toReversed',
  'toSorted',
  'toSpliced',
  'with',
  'toLocaleString',
  'toString',

  // Document
  'implementation',
  'URL',
  'documentURI',
  'compatMode',
  'characterSet',
  'charset',
  'inputEncoding',
  'contentType',
  'doctype',
  'documentElement',
  'xmlEncoding',
  'xmlVersion',
  'xmlStandalone',
  'domain',
  'referrer',
  'cookie',
  'lastModified',
  'readyState',
  'title',
  'dir',
  'body',
  'head',
  'images',
  'embeds',
  'plugins',
  'links',
  'forms',
  'scripts',
  'currentScript',
  'defaultView',
  'designMode',
  'onreadystatechange',
  'anchors',
  'applets',
  'fgColor',
  'linkColor',
  'vlinkColor',
  'alinkColor',
  'bgColor',
  'all',
  'scrollingElement',
  'onpointerlockchange',
  'onpointerlockerror',
  'hidden',
  'visibilityState',
  'wasDiscarded',
  'prerendering',
  'featurePolicy',
  'webkitVisibilityState',
  'webkitHidden',
  'onbeforecopy',
  'onbeforecut',
  'onbeforepaste',
  'onfreeze',
  'onprerenderingchange',
  'onresume',
  'onsearch',
  'onvisibilitychange',
  'timeline',
  'fullscreenEnabled',
  'fullscreen',
  'onfullscreenchange',
  'onfullscreenerror',
  'webkitIsFullScreen',
  'webkitCurrentFullScreenElement',
  'webkitFullscreenEnabled',
  'webkitFullscreenElement',
  'onwebkitfullscreenchange',
  'onwebkitfullscreenerror',
  'rootElement',
  'pictureInPictureEnabled',
  'onbeforexrselect',
  'onabort',
  'onbeforeinput',
  'onbeforematch',
  'onbeforetoggle',
  'onblur',
  'oncancel',
  'oncanplay',
  'oncanplaythrough',
  'onchange',
  'onclick',
  'onclose',
  'oncontentvisibilityautostatechange',
  'oncontextlost',
  'oncontextmenu',
  'oncontextrestored',
  'oncuechange',
  'ondblclick',
  'ondrag',
  'ondragend',
  'ondragenter',
  'ondragleave',
  'ondragover',
  'ondragstart',
  'ondrop',
  'ondurationchange',
  'onemptied',
  'onended',
  'onerror',
  'onfocus',
  'onformdata',
  'oninput',
  'oninvalid',
  'onkeydown',
  'onkeypress',
  'onkeyup',
  'onload',
  'onloadeddata',
  'onloadedmetadata',
  'onloadstart',
  'onmousedown',
  'onmouseenter',
  'onmouseleave',
  'onmousemove',
  'onmouseout',
  'onmouseover',
  'onmouseup',
  'onmousewheel',
  'onpause',
  'onplay',
  'onplaying',
  'onprogress',
  'onratechange',
  'onreset',
  'onresize',
  'onscroll',
  'onsecuritypolicyviolation',
  'onseeked',
  'onseeking',
  'onselect',
  'onslotchange',
  'onstalled',
  'onsubmit',
  'onsuspend',
  'ontimeupdate',
  'ontoggle',
  'onvolumechange',
  'onwaiting',
  'onwebkitanimationend',
  'onwebkitanimationiteration',
  'onwebkitanimationstart',
  'onwebkittransitionend',
  'onwheel',
  'onauxclick',
  'ongotpointercapture',
  'onlostpointercapture',
  'onpointerdown',
  'onpointermove',
  'onpointerrawupdate',
  'onpointerup',
  'onpointercancel',
  'onpointerover',
  'onpointerout',
  'onpointerenter',
  'onpointerleave',
  'onselectstart',
  'onselectionchange',
  'onanimationend',
  'onanimationiteration',
  'onanimationstart',
  'ontransitionrun',
  'ontransitionstart',
  'ontransitionend',
  'ontransitioncancel',
  'oncopy',
  'oncut',
  'onpaste',
  'children',
  'firstElementChild',
  'lastElementChild',
  'childElementCount',
  'activeElement',
  'styleSheets',
  'pointerLockElement',
  'fullscreenElement',
  'adoptedStyleSheets',
  'pictureInPictureElement',
  'fonts',
  'adoptNode',
  'append',
  'captureEvents',
  'caretRangeFromPoint',
  'clear',
  'close',
  'createAttribute',
  'createAttributeNS',
  'createCDATASection',
  'createComment',
  'createDocumentFragment',
  'createElement',
  'createElementNS',
  'createEvent',
  'createExpression',
  'createNSResolver',
  'createNodeIterator',
  'createProcessingInstruction',
  'createRange',
  'createTextNode',
  'createTreeWalker',
  'elementFromPoint',
  'elementsFromPoint',
  'evaluate',
  'execCommand',
  'exitFullscreen',
  'exitPictureInPicture',
  'exitPointerLock',
  'getAnimations',
  'getElementById',
  'getElementsByClassName',
  'getElementsByName',
  'getElementsByTagName',
  'getElementsByTagNameNS',
  'getSelection',
  'hasFocus',
  'hasStorageAccess',
  'hasUnpartitionedCookieAccess',
  'importNode',
  'open',
  'prepend',
  'queryCommandEnabled',
  'queryCommandIndeterm',
  'queryCommandState',
  'queryCommandSupported',
  'queryCommandValue',
  'querySelector',
  'querySelectorAll',
  'releaseEvents',
  'replaceChildren',
  'requestStorageAccess',
  'requestStorageAccessFor',
  'startViewTransition',
  'webkitCancelFullScreen',
  'webkitExitFullscreen',
  'write',
  'writeln',
  'constructor',
  'fragmentDirective',
  'browsingTopics',
  'hasPrivateToken',
  'hasRedemptionRecord',
  'onscrollend',

  // KeyboardEvent
  'key',
  'code',
  'location',
  'ctrlKey',
  'shiftKey',
  'altKey',
  'metaKey',
  'repeat',
  'isComposing',
  'charCode',
  'keyCode',
  'getModifierState',
  'initKeyboardEvent',
  'constructor',

  // HTMLElement
  'style',

  // HTMLCanvasElement
  'width',
  'height',
  'captureStream',
  'getContext',
  'toBlob',
  'toDataURL',
  'transferControlToOffscreen',
  'constructor',

  // CanvasRenderingContext2D
  'canvas',
  'globalAlpha',
  'globalCompositeOperation',
  'filter',
  'imageSmoothingEnabled',
  'imageSmoothingQuality',
  'strokeStyle',
  'fillStyle',
  'shadowOffsetX',
  'shadowOffsetY',
  'shadowBlur',
  'shadowColor',
  'lineWidth',
  'lineCap',
  'lineJoin',
  'miterLimit',
  'lineDashOffset',
  'font',
  'textAlign',
  'textBaseline',
  'direction',
  'fontKerning',
  'fontStretch',
  'fontVariantCaps',
  'letterSpacing',
  'textRendering',
  'wordSpacing',
  'clip',
  'createConicGradient',
  'createImageData',
  'createLinearGradient',
  'createPattern',
  'createRadialGradient',
  'drawFocusIfNeeded',
  'drawImage',
  'fill',
  'fillText',
  'getContextAttributes',
  'getImageData',
  'getLineDash',
  'getTransform',
  'isContextLost',
  'isPointInPath',
  'isPointInStroke',
  'measureText',
  'putImageData',
  'reset',
  'roundRect',
  'save',
  'scale',
  'setLineDash',
  'setTransform',
  'stroke',
  'strokeText',
  'transform',
  'translate',
  'arc',
  'arcTo',
  'beginPath',
  'bezierCurveTo',
  'clearRect',
  'closePath',
  'ellipse',
  'fillRect',
  'lineTo',
  'moveTo',
  'quadraticCurveTo',
  'rect',
  'resetTransform',
  'restore',
  'rotate',
  'strokeRect',
  'constructor',

  // WebGLRenderingContext
  'canvas',
  'drawingBufferWidth',
  'drawingBufferHeight',
  'drawingBufferColorSpace',
  'unpackColorSpace',
  'activeTexture',
  'attachShader',
  'bindAttribLocation',
  'bindRenderbuffer',
  'blendColor',
  'blendEquation',
  'blendEquationSeparate',
  'blendFunc',
  'blendFuncSeparate',
  'bufferData',
  'bufferSubData',
  'checkFramebufferStatus',
  'compileShader',
  'compressedTexImage2D',
  'compressedTexSubImage2D',
  'copyTexImage2D',
  'copyTexSubImage2D',
  'createBuffer',
  'createFramebuffer',
  'createProgram',
  'createRenderbuffer',
  'createShader',
  'createTexture',
  'cullFace',
  'deleteBuffer',
  'deleteFramebuffer',
  'deleteProgram',
  'deleteRenderbuffer',
  'deleteShader',
  'deleteTexture',
  'depthFunc',
  'depthMask',
  'depthRange',
  'detachShader',
  'disable',
  'enable',
  'finish',
  'flush',
  'framebufferRenderbuffer',
  'framebufferTexture2D',
  'frontFace',
  'generateMipmap',
  'getActiveAttrib',
  'getActiveUniform',
  'getAttachedShaders',
  'getAttribLocation',
  'getBufferParameter',
  'getContextAttributes',
  'getError',
  'getExtension',
  'getFramebufferAttachmentParameter',
  'getParameter',
  'getProgramInfoLog',
  'getProgramParameter',
  'getRenderbufferParameter',
  'getShaderInfoLog',
  'getShaderParameter',
  'getShaderPrecisionFormat',
  'getShaderSource',
  'getSupportedExtensions',
  'getTexParameter',
  'getUniform',
  'getUniformLocation',
  'getVertexAttrib',
  'getVertexAttribOffset',
  'hint',
  'isBuffer',
  'isContextLost',
  'isEnabled',
  'isFramebuffer',
  'isProgram',
  'isRenderbuffer',
  'isShader',
  'isTexture',
  'lineWidth',
  'linkProgram',
  'pixelStorei',
  'polygonOffset',
  'readPixels',
  'renderbufferStorage',
  'sampleCoverage',
  'shaderSource',
  'stencilFunc',
  'stencilFuncSeparate',
  'stencilMask',
  'stencilMaskSeparate',
  'stencilOp',
  'stencilOpSeparate',
  'texImage2D',
  'texParameterf',
  'texParameteri',
  'texSubImage2D',
  'useProgram',
  'validateProgram',
  'bindBuffer',
  'bindFramebuffer',
  'bindTexture',
  'clear',
  'clearColor',
  'clearDepth',
  'clearStencil',
  'colorMask',
  'disableVertexAttribArray',
  'drawArrays',
  'drawElements',
  'enableVertexAttribArray',
  'scissor',
  'uniform1f',
  'uniform1fv',
  'uniform1i',
  'uniform1iv',
  'uniform2f',
  'uniform2fv',
  'uniform2i',
  'uniform2iv',
  'uniform3f',
  'uniform3fv',
  'uniform3i',
  'uniform3iv',
  'uniform4f',
  'uniform4fv',
  'uniform4i',
  'uniform4iv',
  'uniformMatrix2fv',
  'uniformMatrix3fv',
  'uniformMatrix4fv',
  'vertexAttrib1f',
  'vertexAttrib1fv',
  'vertexAttrib2f',
  'vertexAttrib2fv',
  'vertexAttrib3f',
  'vertexAttrib3fv',
  'vertexAttrib4f',
  'vertexAttrib4fv',
  'vertexAttribPointer',
  'viewport',
  'drawingBufferFormat',
  'drawingBufferStorage',
  'constructor',
  'makeXRCompatible',

  // WebGL2RenderingContext
  'canvas',
  'drawingBufferWidth',
  'drawingBufferHeight',
  'drawingBufferColorSpace',
  'unpackColorSpace',
  'activeTexture',
  'attachShader',
  'beginQuery',
  'beginTransformFeedback',
  'bindAttribLocation',
  'bindBufferBase',
  'bindBufferRange',
  'bindRenderbuffer',
  'bindSampler',
  'bindTransformFeedback',
  'bindVertexArray',
  'blendColor',
  'blendEquation',
  'blendEquationSeparate',
  'blendFunc',
  'blendFuncSeparate',
  'blitFramebuffer',
  'bufferData',
  'bufferSubData',
  'checkFramebufferStatus',
  'clientWaitSync',
  'compileShader',
  'compressedTexImage2D',
  'compressedTexImage3D',
  'compressedTexSubImage2D',
  'compressedTexSubImage3D',
  'copyBufferSubData',
  'copyTexImage2D',
  'copyTexSubImage2D',
  'copyTexSubImage3D',
  'createBuffer',
  'createFramebuffer',
  'createProgram',
  'createQuery',
  'createRenderbuffer',
  'createSampler',
  'createShader',
  'createTexture',
  'createTransformFeedback',
  'createVertexArray',
  'cullFace',
  'deleteBuffer',
  'deleteFramebuffer',
  'deleteProgram',
  'deleteQuery',
  'deleteRenderbuffer',
  'deleteSampler',
  'deleteShader',
  'deleteSync',
  'deleteTexture',
  'deleteTransformFeedback',
  'deleteVertexArray',
  'depthFunc',
  'depthMask',
  'depthRange',
  'detachShader',
  'disable',
  'drawArraysInstanced',
  'drawElementsInstanced',
  'drawRangeElements',
  'enable',
  'endQuery',
  'endTransformFeedback',
  'fenceSync',
  'finish',
  'flush',
  'framebufferRenderbuffer',
  'framebufferTexture2D',
  'framebufferTextureLayer',
  'frontFace',
  'generateMipmap',
  'getActiveAttrib',
  'getActiveUniform',
  'getActiveUniformBlockName',
  'getActiveUniformBlockParameter',
  'getActiveUniforms',
  'getAttachedShaders',
  'getAttribLocation',
  'getBufferParameter',
  'getBufferSubData',
  'getContextAttributes',
  'getError',
  'getExtension',
  'getFragDataLocation',
  'getFramebufferAttachmentParameter',
  'getIndexedParameter',
  'getInternalformatParameter',
  'getParameter',
  'getProgramInfoLog',
  'getProgramParameter',
  'getQuery',
  'getQueryParameter',
  'getRenderbufferParameter',
  'getSamplerParameter',
  'getShaderInfoLog',
  'getShaderParameter',
  'getShaderPrecisionFormat',
  'getShaderSource',
  'getSupportedExtensions',
  'getSyncParameter',
  'getTexParameter',
  'getTransformFeedbackVarying',
  'getUniform',
  'getUniformBlockIndex',
  'getUniformIndices',
  'getUniformLocation',
  'getVertexAttrib',
  'getVertexAttribOffset',
  'hint',
  'invalidateFramebuffer',
  'invalidateSubFramebuffer',
  'isBuffer',
  'isContextLost',
  'isEnabled',
  'isFramebuffer',
  'isProgram',
  'isQuery',
  'isRenderbuffer',
  'isSampler',
  'isShader',
  'isSync',
  'isTexture',
  'isTransformFeedback',
  'isVertexArray',
  'lineWidth',
  'linkProgram',
  'pauseTransformFeedback',
  'pixelStorei',
  'polygonOffset',
  'readBuffer',
  'readPixels',
  'renderbufferStorage',
  'renderbufferStorageMultisample',
  'resumeTransformFeedback',
  'sampleCoverage',
  'samplerParameterf',
  'samplerParameteri',
  'shaderSource',
  'stencilFunc',
  'stencilFuncSeparate',
  'stencilMask',
  'stencilMaskSeparate',
  'stencilOp',
  'stencilOpSeparate',
  'texImage2D',
  'texImage3D',
  'texParameterf',
  'texParameteri',
  'texStorage2D',
  'texStorage3D',
  'texSubImage2D',
  'texSubImage3D',
  'transformFeedbackVaryings',
  'uniform1ui',
  'uniform2ui',
  'uniform3ui',
  'uniform4ui',
  'uniformBlockBinding',
  'useProgram',
  'validateProgram',
  'vertexAttribDivisor',
  'vertexAttribI4i',
  'vertexAttribI4ui',
  'vertexAttribIPointer',
  'waitSync',
  'bindBuffer',
  'bindFramebuffer',
  'bindTexture',
  'clear',
  'clearBufferfi',
  'clearBufferfv',
  'clearBufferiv',
  'clearBufferuiv',
  'clearColor',
  'clearDepth',
  'clearStencil',
  'colorMask',
  'disableVertexAttribArray',
  'drawArrays',
  'drawBuffers',
  'drawElements',
  'enableVertexAttribArray',
  'scissor',
  'uniform1f',
  'uniform1fv',
  'uniform1i',
  'uniform1iv',
  'uniform1uiv',
  'uniform2f',
  'uniform2fv',
  'uniform2i',
  'uniform2iv',
  'uniform2uiv',
  'uniform3f',
  'uniform3fv',
  'uniform3i',
  'uniform3iv',
  'uniform3uiv',
  'uniform4f',
  'uniform4fv',
  'uniform4i',
  'uniform4iv',
  'uniform4uiv',
  'uniformMatrix2fv',
  'uniformMatrix2x3fv',
  'uniformMatrix2x4fv',
  'uniformMatrix3fv',
  'uniformMatrix3x2fv',
  'uniformMatrix3x4fv',
  'uniformMatrix4fv',
  'uniformMatrix4x2fv',
  'uniformMatrix4x3fv',
  'vertexAttrib1f',
  'vertexAttrib1fv',
  'vertexAttrib2f',
  'vertexAttrib2fv',
  'vertexAttrib3f',
  'vertexAttrib3fv',
  'vertexAttrib4f',
  'vertexAttrib4fv',
  'vertexAttribI4iv',
  'vertexAttribI4uiv',
  'vertexAttribPointer',
  'viewport',
  'drawingBufferFormat',
  'drawingBufferStorage',
  'constructor',
  'makeXRCompatible',

  // AudioContext
  'sampleRate',
  'createGain',
  'connect',
  'baseLatency',
  'outputLatency',
  'close',
  'createMediaElementSource',
  'createMediaStreamDestination',
  'createMediaStreamSource',
  'getOutputTimestamp',
  'resume',
  'suspend',
  'constructor',
  'sinkId',
  'onsinkchange',
  'setSinkId',
  'linearRampToValueAtTime',

  // BaseAudioContext
  'destination',
  'currentTime',
  'sampleRate',
  'listener',
  'state',
  'onstatechange',
  'createAnalyser',
  'createBiquadFilter',
  'createBuffer',
  'createBufferSource',
  'createChannelMerger',
  'createChannelSplitter',
  'createConstantSource',
  'createConvolver',
  'createDelay',
  'createDynamicsCompressor',
  'createGain',
  'createIIRFilter',
  'createOscillator',
  'createPanner',
  'createPeriodicWave',
  'createScriptProcessor',
  'createStereoPanner',
  'createWaveShaper',
  'decodeAudioData',
  'constructor',
  'audioWorklet',

  // AudioNode
  'context',
  'numberOfInputs',
  'numberOfOutputs',
  'channelCount',
  'channelCountMode',
  'channelInterpretation',
  'connect',
  'disconnect',
  'constructor',

  // GainNode
  'gain',
  'constructor',

  // AudioBuffer
  'length',
  'duration',
  'sampleRate',
  'numberOfChannels',
  'copyFromChannel',
  'copyToChannel',
  'getChannelData',
  'constructor',

  // AudioBufferSourceNode
  'buffer',
  'playbackRate',
  'detune',
  'loop',
  'loopStart',
  'loopEnd',
  'start',
  'constructor',

  // AudioScheduledSourceNode
  'onended',
  'start',
  'stop',
  'constructor',
];

export default defineConfig(config);
